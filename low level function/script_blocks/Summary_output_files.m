%% Summary analysis output

writetable(ICsummary,['ephys_features_', date,'.csv'], 'WriteRowNames',true)

%% QC parameter
% access = IC.access_resistance;
% Ra_rela_cut = IC.tp_membrR*params.factorRelaRa;
% tp_Rm = IC.tp_membrR;
% preqc_Rm = IC.resistance_preqc;
% 
% for n = 1:length(IC.ID)
% qc_bridgebalance(n,1:qc.LP.nr_sweeps(n,1)+qc.SP.nr_sweeps(n,1)) = ...
%     [qc.LP.bridg_bala(n,1:qc.LP.nr_sweeps(n,1)), ...
%       qc.SP.bridg_bala(n,1:qc.SP.nr_sweeps(n,1))];
% qc_holding_current(n,1:qc.LP.nr_sweeps(n,1)+qc.SP.nr_sweeps(n,1)) = ...
%     [qc.LP.I_hold(n,1:qc.LP.nr_sweeps(n,1)), ...
%       qc.SP.I_hold(n,1:qc.SP.nr_sweeps(n,1))];
% qc_restVdiffpreNpost(n,1:qc.LP.nr_sweeps(n,1)+qc.SP.nr_sweeps(n,1)) = ...
%     [qc.LP.restVdiffpreNpost(n,1:qc.LP.nr_sweeps(n,1)), ...
%       qc.SP.restVdiffpreNpost(n,1:qc.SP.nr_sweeps(n,1))];
% qc_rmse_pre_lt(n,1:qc.LP.nr_sweeps(n,1)+qc.SP.nr_sweeps(n,1)) = ...
%     [qc.LP.rmse_pre_lt(n,1:qc.LP.nr_sweeps(n,1)), ...
%       qc.SP.rmse_pre_lt(1:qc.SP.nr_sweeps(n,1))]; 
% qc_rmse_post_lt(n,1:qc.LP.nr_sweeps(n,1)+qc.SP.nr_sweeps(n,1)) = ...
%     [qc.LP.rmse_post_lt(n,1:qc.LP.nr_sweeps(n,1)), ...
%       qc.SP.rmse_post_lt(n,1:qc.SP.nr_sweeps(n,1))];  
% end
% 
% T1 = table(ID,access, tp_Rm,preqc_Rm , Ra_rela_cut);
% T2 = table(ID,qc_bridgebalance);
% T3 = table(ID,qc_holding_current);
% T4 = table(ID,qc_restVdiffpreNpost);
% T5 = table(ID,qc_rmse_pre_lt);
% T6 = table(ID,qc_rmse_post_lt);
% 
% writetable(T1,[outDest,'qc parameters ',date,'.xlsx'], ...
%     'Sheet', 'Initial Access','WriteRowNames',true)
% writetable(T2,[outDest,'qc parameters ',date,'.xlsx'], ...
%     'Sheet', 'Bridge Balance','WriteRowNames',true)  
% writetable(T3,[outDest,'qc parameters ',date,'.xlsx'], ...
%     'Sheet', 'holding current','WriteRowNames',true)
% writetable(T4,[outDest,'qc parameters ',date,'.xlsx'], ...
%      'Sheet', 'VoltageDiffpreNpost','WriteRowNames',true)
% writetable(T5,[outDest,'qc parameters ',date,'.xlsx'], ...
%      'Sheet', 'lt RMSE pre','WriteRowNames',true)  
% writetable(T6,[outDest,'qc parameters ',date,'.xlsx'], ...
%      'Sheet', 'lt RMSE post','WriteRowNames',true)
%   
%% QC logic sweeps per class matrix 

writetable(QC_removalsPerTag, [outDest,'QC_sweeps_per_tag_matrix_',date,'.csv'], 'WriteRowNames',true);

%% ID look up table    
% varNames = {'new cellID','old cellID'};
% T= table(IC.ID_new, IC.ID, 'VariableNames',varNames);
% writetable(T, [outDest,'ID_lookup','.csv'] );   

%% procedure doc file
rowNames = {'Standard';'Cell-wise: initial R_a';'Cell-wise: initial R_a fract'; ...
    'Cell-wise: electrode drift'; 'Sweep-wise: bridge balance abs'; ...
    'Sweep-wise: bridge balance fract'; 'Sweep-wise: max I hold'; ...
    'Sweep-wise: maximum RMP'; ...
    'Sweep-wise: maximum deviation from start RMP'
    'Sweep-wise: pre post voltage stability'
    'Sweep-wise: st RMSE'; 'Sweep-wise: lt RMSE'; ...
    'Sweep-wise: LP averaging window pre stim'; ...
    'Sweep-wise: SP averaging window pre stim'; ...
    'Sweep-wise: start window post from stim onset LP'; ...  
    'Sweep-wise: start window post from stim onset stim SP'; ...
    'Sweep-wise: min Frac good Sp'; ...
    'Spike-wise: min SpAmp narrow'; 'Spike-wise: min SpAmp broad'; ...
    'Spike-wise: max threshold'; 'time'; 'path'; 'computer'; 'Matlab'   
    };
T= array2table([["Current Run", "Allen White Paper"];...
    [params.cutoffInitRa, 20];...
    [params.factorRelaRa, "0.2(human);0.15(mouse)"]; ...
    ["not implemented", "1 mV for every 10 min after start WC"]; ...
    [string(params.bridge_balance) , "20"]; ...
    [params.factorRelaRa , "0.2(human);0.15(mouse)"]; ...
    ["100 (abs)", "100 (abs)"]; ...
    [params.maximumRestingPot , "not implemented"]; ...
    [params.BwSweepMax, "not implemented"]; ...
    [params.maxDiffBwBeginEnd, "1"]; ...
    [params.RMSEst, "0.07"]; ...
    [params.RMSElt, "0.5"]; ...
    [params.LPqc_samplWind , "-"]; ...
    [params.SPqc_samplWind , "-"]; ...
    [params.LPqc_recovTime + 1000, "-"]; ...
    [params.SPqc_recovTime + 3, "-"]; ...
    [params.minGoodSpFra, "not implemented"]; ...
    [params.minDiffThreshold2PeakN, "not implemented"]; ...
    [params.minDiffThreshold2PeakB, "not implemented"]; ...
    [params.maxThreshold , "not implemented"]; ...    
    [string(datestr(now,'HH:MM:SS')), "-"]; ... 
    [mainFolder , "-"]; ... 
    [computer, "-"]; ... 
    [version, "-"]]...
     , 'RowNames', rowNames...
  );

writetable(T, [outDest,'procedure_doc_', date,'.csv'],'WriteRowNames',true, ...
    'WriteVariableNames', false);   